/*! Drum.JS - v0.1dev - 2014-01-09
 * http://mb.aquarius.uberspace.de/drum.js
 *
 * Copyright (c) 2013 Marcel Bretschneider <marcel.bretschneider@gmail.com>;
 * Licensed under the MIT license */
!function(t){"use strict";var e=function(){var e=function(t){return document.createElementNS("http://www.w3.org/2000/svg",t)},n=function(n,a){var r=t(e("svg"));t(r).attr("width",n),t(r).attr("height",a);var i=t(e("g"));return t(r).append(i),r},a=function(e){var n=document.createElement("div");t(n).attr("class",e);var a=document.createElement("div");return t(n).append(a),n},r=function(n){var a=t(e("path")),r={fill:"none",stroke:n.dail_stroke_color,"stroke-width":n.dail_stroke_width+"px","stroke-linecap":"butt","stroke-linejoin":"miter","stroke-opacity":"1"};for(var i in r)t(a).attr(i,r[i]);return a};return{up:function(e){var i=e.dail_w,d=e.dail_h,o=n(i,d),s=r(e);t(s).attr("d","m0,"+(d+e.dail_stroke_width)+"l"+i/2+",-"+d+"l"+i/2+","+d),t(o).find("g").append(s);var l=a("dial up");return t(l).find("div").append(o),l},down:function(e){var i=e.dail_w,d=e.dail_h,o=n(i,d),s=r(e);t(s).attr("d","m0,-"+e.dail_stroke_width+"l"+i/2+","+d+"l"+i/2+",-"+d),t(o).find("g").append(s);var l=a("dial down");return t(l).find("div").append(o),l}}}(),n=function(e,n,a){this.index=e,this.dataModel=new function(t,e){this.data=t,this.index=e,this.getText=function(){return this.data[this.index]}}(a.data,n),this.init=function(){this.angle=a.theta*e,this.elem=document.createElement("figure"),t(this.elem).addClass("a"+100*this.angle),t(this.elem).css("opacity","0.5"),t(this.elem).css(a.transformProp,a.rotateFn+"("+.6*-this.angle+"deg) translateZ("+a.radius+"rem)"),this.setText()},this.setText=function(){t(this.elem).text(this.dataModel.getText())},this.update=function(t){this.dataModel.index!=t&&(this.dataModel.index=t,this.setText())}},a=function(a,r,i){var d=t(a)[0],o=t.extend({panelCount:16,rotateFn:"rotateX",interactive:!0,dail_w:20,dail_h:5,dail_stroke_color:"#999999",dail_stroke_width:1},r||{});if(o.transformProp=i,o.rotation=0,o.distance=0,o.last_angle=0,o.theta=360/o.panelCount,o.initselect=d.selectedIndex,o.transformProp){o.data=[];for(var s=0;s<d.children.length;s++)o.data.push(t(d.children[s]).text());t(a).hide();var l=document.createElement("div");t(l).addClass("drum-wrapper"),o.id?t(l).attr("id",o.id):d.id?t(l).attr("id","drum_"+d.id):t(d).attr("name")&&t(l).attr("id","drum_"+t(d).attr("name")),t(d).after(l);var u=document.createElement("div");t(u).addClass("inner"),t(u).appendTo(l);var c=document.createElement("div");t(c).addClass("container"),t(c).appendTo(u);var h=document.createElement("div");if(t(h).addClass("drum"),t(h).appendTo(c),o.interactive===!0){var p=e.up(o);t(l).append(p);var f=e.down(o);t(l).append(f)}o.radius=Math.round(t(h).height()/2/Math.tan(Math.PI/o.panelCount))/16,o.mapping=[];for(var m=0,s=0;s<o.panelCount&&o.data.length!=s;s++){var v=m;m>=o.panelCount/2&&(v=o.data.length-(o.panelCount-m)),m++;var g=new n(s,v,o);g.init(),o.mapping.push(g),t(h).append(g.elem)}var x=function(t){t=t||o.rotation;var e=o.theta/2,n=360,a=((t+e)%n+n)%n;a-=a%o.theta;var r=(o.data.length-1)*o.theta;return a>r?t>0?r:0:a},_=function(){var t=x();for(var e in o.mapping)if(o.mapping[e].angle==t)return o.mapping[e]},w=function(t){for(var e,n=[],a=o.panelCount,r=o.panelCount/2,i=o.data.length,d=t.index,s=t.dataModel.index,l=s-r;s+r-1>=l;l++)e=l,0>l&&(e=i+l),l>i-1&&(e=l-i),n.push(e);var u=n.slice(r-d);n=u.concat(n.slice(0,a-u.length));for(var d=0;d<o.mapping.length;d++)o.mapping[d].update(n[d])},C=function(e){t(h).css(o.transformProp,"translateZ(-"+o.radius+"rem) "+o.rotateFn+"("+.6*o.rotation+"deg)");var n=_();if(n){var a=n.dataModel,r=d.selectedIndex;d.selectedIndex=a.index,e&&r!=a.index&&o.onChange&&o.onChange(d),t(n.elem).css("opacity",1),t("figure:not(.a"+100*n.angle+", .hidden)",h).css("opacity","0.5"),n.angle!=o.last_angle&&[0,90,180,270].indexOf(n.angle)>=0&&(o.last_angle=n.angle,w(n))}};this.setIndex=function(t){var e=Math.floor(t/o.panelCount),a=t-e*o.panelCount,r=new n(a,t,o);w(r),o.rotation=a*o.theta,C(!1)}}else this.setIndex=function(t){d.selectedIndex=t};this.setIndex(o.initselect),this.getIndex=function(){return o.transformProp?_().dataModel.index:d.selectedIndex},o.transformProp&&("undefined"!=typeof Hammer&&(o.touch=new Hammer(l,{prevent_default:!0,no_mouseevents:!0}),o.touch.on("dragstart",function(t){o.distance=0}),o.touch.on("drag",function(t){var e=["up","down"];e.indexOf(t.gesture.direction)>=0&&(o.rotation+=-1*Math.round(t.gesture.deltaY-o.distance),C(!0),o.distance=t.gesture.deltaY)}),o.touch.on("dragend",function(t){o.rotation=x(),C(!0)})),o.interactive&&(t(p).click(function(t){var e=o.rotation+o.theta+1;o.rotation=x(e),C(!0)}),t(f).click(function(t){var e=o.rotation-o.theta-1;o.rotation=x(e),C(!0)})))},r={getIndex:function(){return t(this).data("drum")?t(this).data("drum").getIndex():!1},setIndex:function(e){t(this).data("drum")&&t(this).data("drum").setIndex(e)},init:function(e){var n=!1;if(!navigator.userAgent.match(/Trident/i)&&!navigator.userAgent.match(/MSIE/i))for(var r="transform WebkitTransform MozTransform OTransform msTransform".split(" "),i=0;i<r.length;i++)void 0!==document.createElement("div").style[r[i]]&&(n=r[i]);var d=t(this);if(!d.data("drum")){var o=new a(d,e,n);d.data("drum",o)}}};t.fn.drum=function(e){var n=arguments;return this.each(function(){return r[e]?r[e].apply(this,Array.prototype.slice.call(n,1)):"object"!=typeof e&&e?void t.error("Method "+e+" does not exist on jQuery.drum"):r.init.apply(this,n)})}}(jQuery);